# Принципы реализации

В настоящей главе мы опишем принципы и механизмы реализации мер по защите информации,
использованные при создании исходных текстов библиотеки `libakrypt`.
При рассмотрении возможной модели поведения нарушителя,
то есть субъекта от которого  обеспечивается защита,
мы выбрали возможности, изложенные в методических рекомендациях
Р 1323565.1.012-2017
«Информационная технология. Криптографическая защита информации.
Принципы разработки и модернизации шифровальных (криптографических) средств защиты информации».

Это привело к необходимости обеспечить защиту по следующим направлениям:

* перехват информации, передаваемой по открытым каналам связи или хранимой в открытом доступе;
это приводит к необходимости шифровать сетевой трафик и зашифровывать хранящиеся и передаваемые по сети файлы;

* защита от непредсказуемых ошибок аппаратного обеспечения; это приводит к необходимости
контролировать целостность информации в процессе ее обработки, а также реализовывать меры
по маскированию криптографически опасной информации на случай незапланированного нарушения эксплуатации
аппаратных средств
и сброса ключевой ифнормации на диск в незашифрованном виде;

* защита от перехвата излучений и сигналов, вырабатываемых программными и аппаратными средствами,
на которых выполняется защита информации; это приводит к необходимости реализации мер защиты как от временных атак
на исполняемый код, так и защите от побочных излучений по электро-магнитным каналам утечки информации (ПЭМИН);

* защита от преднамеренных действий пользователя, направленных на
искажение обрабатываемой информации, определение используемой ключевой информации или
нарушение логики работы функций библиотеки;

* ведение аудита выполненных библиотекой криптографических преобразоований и защита файлов аудита от
преднамеренных или непреднамеренных искажений.


Для обеспечения защиты по указанным направлениям и обеспечения
безопасности защищаемой информации
и исполняемого кода, мы сформулировали и реализовали
ряд технических и организационных принципов разработки исходных текстов.
Данные принципы должны соблюдаться при модификации библиотеки и
расширении ее функциональных возможностей.

### Состав исходных текстов библиотеки

1. Следование стандарту С11 и максимальная кросс-платформенность. Исходные тексты, включаемые в состав библиотеки,
должны быть успешно скомпилированы и корректно исполнены для максимально возможного
числа компиляторов языка С и операционных систем.

2. Минимально возможное использование внешних зависимостей и библиотек.

3. Минимальное включение кода, то есть исключение из тела библиотеки фрагментов исходных текстов, которые реально
не используются или предоставляют мало востребованный пользовательский интерфейс.
Функции пользовательского интерфейса, не используемые при выполнении криптографических преобразований,
также должны быть выведены из состава библиотеки.

4. В случае, если некоторая функциональность не может быть реализована без использования
неэкспортируемых типов данных и функций, то данная функциональность должна быть включена в состав библиотеки
в соответствии с данными принципами. Это привело к тому, что в библиотеку была включена собственная
реализация операций с большими целыми числами, собственные функции разбора сообщений в формате ASN1 и т.п.

5. Максимальное документирование исходных текстов, включая не только описание аргументов
функций и возвращаемых значений, а также описание принципов реализации конкретных криптографических алгоритмов.
В документацию также должны включаться рекомендации по расширению функциональных возможностей библиотеки.

### Средства ограничения доступа к данным и ключевой информации

1. Каждому криптографическому преобразованию должен соответствовать уникальный
класс (совокупность данных и методов их обработки), объекты которого могут разделять совместно
только методы обработки данных, но не сами данные.
Примером такого подхода к реализации является класс секретного ключа некоего блочного
алгоритма шифрования (см. struct \ref bckey). Каждый объект класса представляет собой ключ алгоритма шифрования,
уникальный для каждого объекта. При этом методы - функции зашифрования и расширования -
для всех ключей одного конкретного алгоритма шифрования могут совпадать.


2. Каждый класс должен иметь единооборазный набор конструкторов и деструкторов,
что позволяет организовать единообразный доступ к объектам, в частности, удаление объектов из памяти.

3. Создание объекта конкретного класса возможно только с помощью производящей функции.
Любой другой механизм создания объектов считается недопустимым.


4. Описание конкретной реализации класса (полей структуры, типов, используемых при описании ее данных,
перечень функций обработки данных) не экспортируется и не должно быть использовано за
пределами исходных текстов библиотеки.

5. Механизмы работы с контекстами (указателями на созданные в ходе выполнения кода библиотеки объекты)
не экспортируются. Указатели на созданные объекты не экспортируются.

6. Для доступа пользователя к объектам, создаваемым библиотекой, реализован механизм дескрипторов,
которые однозначно связываются с конкретными объектами.

7. Значение дескриптора не должно нести в себе какой-либо информации о типе или каких-либо других характеристиках
объекта с которым связан дескриптор. Данная информация должна предоставляться пользователю
с помощью интерфейсных функций.

### Регламенитируемая последовательность действий

1. При старте библиотеки должен производиться контроль ее работоспособности для всех реализованных
криптографических механизмов.

2. При завершении работы библиотека должна самостоятельно контролировать очистку оперативной памяти,
выделенной в процессе ее работы.

3. Библиотека должна вести аудит (документирование) возникающих в ходе ее выполнения ошибок исполнения программы.


Вссе перечисленные принципы
привели к тому, что библиотека содержит два типа интерфейсов. Первый - экспортируемые интерфейсы,
которые могут быть найдены в файле `libakrypt.h`. Данные функции
не позволяют пользователю оперировать с данными напрямую,
предоставляя для работы интерфейс, основанный на применении дескрипторов.

Внутренний интерфейс составляют неэкспортируемые функции. Данные функции могут
напрямую иметь доступ к полям и данным структур с которыми они оперируют,
но при этом они вызываются только в строго предсмотренных случаях
и со строго определенныи аргументами.

Для обеспечения связи между внешним (экспортируемым) интрефейсом
и функциями внутреннего интерфейса в библиотеке реализован менеджер контекстов.
Данный менеджер предназначен для хранения объектов создаваемых классов, связывания
объектов с дескрипторами, доступными пользователю,
и перенаправления запросов пользователя к функциям внутреннего интерфейса.


\section doc_context_manager Менеджер контекстов

\section doc_audit Аудит
В библиотеке реализован механизм аудита - вывода сообщений
о выполняемых библиотекой действиях. В настоящее время реализовано три уровня аудита.

* минимальный (\ref ak_log_none),
* стандартный (\ref ak_log_standard),
* максимальный (\ref ak_log_maximum).

На минимальном уровне выводятся сообщения об ошибках, возникающих к процессе выполнения функций
библиотеки. Коды (численные значения) возможных ошибок могут быть найдены в файле \ref `libakrypt.h`.
Помимо сообщений об ошибках на минимальном уровне выводится сообщение о корректном
тестировании работы всех криптографических механизмов, реализуемых библиотекой
(тестирование происходит в процессе выполнения функции `ak_libakrypt_create()` ).

На стандартном уровне аудита выводятся все сообщения, которые выводятся на минимальном уровне,
а также сообщения о фактах использования ключевой информации. К таким фактам относятся

* факты создания секретных ключей,
* факты удаления секретных ключей,
* ввод секретных ключей с внешних носителей,
* запись секретных ключей на внешние носители и т.п.

На максимальном уровне аудита выводятся все сообщения, которые выводятся на стандартном уровне,
а также отладочные сообщения, позволяющие понять логику работы ряда функций.
Так, выводятся сообщения о процессе тестирования, с кратким описанием тестов и
результатами их выполнения, а также сообщения об изменении эксплуатационных
характеристик библиотеки.

Пример определения функции, реализующей вывод сообщений о выполняемых библиотекой действиях, приводится
нами ранее в разделе \ref tinit_libex2.

В ходе выполнения программы, использующей библиотеку `libakrypt`,
пользователь может узнать установленный для него уровень аудита. Для этого библиотекой
экспортируется функция `ak_log_get_level()`.

Установка уровня аудита из программ, использующих библиотеку `libakrypt`, не допускается.
Уровень аудита относится к контролируемым характеристикам СКЗИ, поэтому
его значение содержится в файле `libakrypt.conf` и считывается перед началом тестирования
криптографических механизмов.
Более подробно о контролируемых характеристиках СКЗИ рассказывается в разделе \ref options.


\section doc_options Опции библиотеки

Точечная настройка работы библиотеки производится с помощью опций
(технических характеристик в терминологии Р 1323565.1.012-2017),
значения которых
влияют как на защищенность обрабатываемых данных, так и на скорость работы ряда функций библиотеки.
Данный значения могут быть настроены как системным администратором в соответствии с действующими требованиями
по безопасности, так и пользователем самостоятельно.

При старте библиотеки значения опций считываются из конфигурационного файла `libakrypt.conf`,
который может располагаться

* в общесистемном каталоге, например, `/etc`; установленный по-умолчанию общесистемный каталог
может быть изменен при настройке библиотеки в вызове команды `cmake`, например,


    cmake -DLIBAKRYPT_CONF=/etc ../libakrypt-0.x

* в домашнем каталоге пользователя, в подкаталоге `.config/libakrypt`.

При старте библиотеки файл с настройками ищется вначале в домашнем каталоге пользователя,
потом в общесистемном каталоге. Если в обоих каталогах файл `libakrypt.conf` не найден,
то библиотека создает этот файл в домашнем каталоге пользователя,
используя при этом значения опций, установленные по умоланию. Реализация этих действий
содержится в функции `ak_libakrypt_load_options()`, вызываемой в обязательном порядке
в самом начале выполнения функции `ak_libakrypt_create()`.

\subsection doc_options_details Реализация и доступ к опциям библиотеки

В файле `ak_tools.h` опция определяется как структура struct \ref option,
содержащая два поля - константную строку с именем опции, а также знаковое 32-х битное целое,
задающее значение опции.


    typedef struct option {
      /* Человекочитаемое имя опции, используется для поиска и установки значения */
      const char *name;
      /*! Численное значение опции (31 значащий бит + знак) */
      ak_int32 value;
    } *ak_option;

В этом же файле определен статический массив options, элементами которого являются структуры \ref option,
содержащие в себе значения всех опций библиотеки по-умолчанию.


    struct option options[] = {
      { "big_endian_architecture", ak_false },
      { "log_level", ak_log_standard },
         ...
      { NULL, 0 } /* завершающая константа, должна всегда принимать нулевые значения */
    };

Считываемые из файла `libakrypt.conf` при старте библиотеки значения
помещаются в данный статический массив и могут быть использованы и модифицированы в ходе работы программы.
При этом, функции для доступа к значениям опций являются экспортируемыми,
а функции для модификации значений опций - не экспорируемыми.

Для доступа к значениям опций могут быть использованы следующие функции,
экспортируемые через заголовочный файл `libakrypt.h`.

* `ak_libakrypt_options_count()` - функция возвращает количество опций,
содержащихся в статическом массиве;

* `ak_libakrypt_get_option_name()` - функция возвращает имя опции с заданным индексом,
значение индекса должно принадлежать интервалу от 0 до значения,
возвращаемого функцией `ak_libakrypt_options_count()` без единицы; при указании неверного индекса возвращается указатель
на null-строку;

* `ak_libakrypt_get_option_value()` - - функция возвращает значение опции с заданным индексом,
значение индекса должно принадлежать интервалу от 0 до значения,
возвращаемого функцией `ak_libakrypt_options_count()` без единицы;
при указании неверного индекса возвращается отрицательное значение,
определяемое константой \ref `ak_error_wrong_option`.

Указанные функции позволяют
организовать достаточно простой способ получения значений всех возможных опций,
например, с помощью следующего цикла.


    for( i = 0; i < ak_libakrypt_options_count()-1; i++ )
      printf("option %s has value %d\n",
         ak_libakrypt_get_option_name(i), ak_libakrypt_get_option_value(i));

Доступ на чтение и запись к опциям библиотеки может быть организован с помощью
неэкспортируемых функций, заголовки которых содержатся в файле `ak_tools.h`.

* `ak_libakrypt_get_option()` - функция возвращает значение опции по ее имени;

* `ak_libakrypt_set_option()` - для опции с заданным именем функция устанавливает ее значение.

С помощью неэкспортируемых функций можно менять текущие значения опций,
например, с помощью следующего кода.


    if( ak_libakrypt_get_option( "some option" ) < 120 )
      ak_libakrypt_set_option( "some option", 120 );


\subsection doc_options_values Описание опций библиотеки

В текущей версии библиотеки реализованы следующие опции.

\subsubsection doc_options_values_log_level Уровень аудита

Опция `log_level` устанавливает уровень аудита библиотеки и может принимать значения 0 (для режима аудита \ref ak_log_none),
1 (для режима аудита \ref ak_log_standard) или 2 (для режима аудита \ref ak_log_maximum).
Опция активно используется в теле функций, вызываемых в теле функции `ak_libakrypt_create()`.

Более подробно о принципах вывода сообщений аудита см. в разделе \ref doc_audit.

\subsubsection doc_options_values_context_manager_size Минимальная вместимость менеджера контекстов

Опция `context_manager_size` устанавливает минимальное число контекстов, которые могут одновременно
находиться в менеджере контекстов. Значение опции определяет минимальный объем выделяемой памяти
под контексты, которые будут создаваться в ходе функционирования библиотеки, и используется в теле функции
`ak_context_manager_create()` при создании менеджера контекстов.
Подробнее о работе менеджера контекстов смотри в разделе \ref doc_context_manager.

Опция `context_manager_size` должна принимать значения в интервале от 32 до 65536.
Проверка и, в случае необходимости, коррекция значения опции происходит при считывании файла `libakrypt.conf`
в теле функции `ak_libakrypt_load_options_from_file()`.


\subsubsection doc_options_values_context_manager_max_size Максимальная вместимость менеджера контекстов

Опция `context_manager_max_size` устанавливает максимально возможное число контекстов,
которые могут одновременно находиться в менеджере контекстов. Значение опции определяет максимально допустимый
объем выделяемой памяти под контексты, которые будут создаваться в ходе функционирования библиотеки.
Значение данной опции используется в теле функции `ak_context_manager_morealloc()`.
Подробнее о работе менеджера контекстов смотри в разделе \ref doc_context_manager.

Опция `context_manager_max_size` должна принимать значения в интервале от 4096 до 2147483647.
Проверка и, в случае необходимости, коррекция значения опции происходит при считывании файла `libakrypt.conf`
в теле функции `ak_libakrypt_load_options_from_file()`.

\subsubsection doc_options_values_key_number_length Длина номеров ключей

Опция `key_number_length` определяет длину номеров ключей, формируемых библиотекой, то есть
задает количество байт, запись которых в шестнадцатеричном виде образует номер ключа.
Номер ключа должен быть уникальным, а его длина должна принимать значения в интервале от 16 до 32.
По-умолчанию значение данной опции равно 16.

\subsubsection doc_options_values_pdkdf2_iteration_count Количество циклов в алгоритме выработки ключа из пароля PBKDF2

Опция `pdkdf2_iteration_count` определяет количество циклов в
алгоритме выработки ключа из пароля PBKDF2, определяемого рекомендациями по стандартизации Р 50.1.111-2016.
При этом, чем больше данное значение, тем медленнее
происходит генерация ключа и тем сложнее реализуется перебор пароля.
Значение опции должно быть не менее 1000, и не более 32768.
По-умолчанию значение данной опции равно 2000.

\subsubsection doc_options_values_hmac_key_count_resource Ресурс ключа для алгоритма выработки имитовставки HMAC

\subsubsection doc_options_values_magma_cipher_resource Ресурс ключа для алгоритма блочного шифрования Магма

\subsubsection doc_options_values_kuznechik_cipher_resource Ресурс ключа для алгоритма блочного шифрования Кузнечик
