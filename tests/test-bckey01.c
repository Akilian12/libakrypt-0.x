 #include <stdio.h>
 #include <stdlib.h>
 #include <ak_bckey.h>
 #include <ak_tools.h>

/*
   https://github.com/gost-engine/engine/blob/master/test_grasshopper.c
*/

 int main( void )
{
  ak_uint8 buf[16];
  struct bckey bkey;

 /* значение секретного ключа согласно ГОСТ Р 34.12-2015 */
  ak_uint8 key[32] = {
    0xef, 0xcd, 0xab, 0x89, 0x67, 0x45, 0x23, 0x01, 0x10, 0x32, 0x54, 0x76, 0x98, 0xba, 0xdc, 0xfe,
    0x77, 0x66, 0x55, 0x44, 0x33, 0x22, 0x11, 0x00, 0xff, 0xee, 0xdd, 0xcc, 0xbb, 0xaa, 0x99, 0x88 };

  ak_uint8 openssl_key[32] = {
    0x88,0x99,0xaa,0xbb,0xcc,0xdd,0xee,0xff,0x00,0x11,0x22,0x33,0x44,0x55,0x66,0x77,
    0xfe,0xdc,0xba,0x98,0x76,0x54,0x32,0x10,0x01,0x23,0x45,0x67,0x89,0xab,0xcd,0xef };

 /* открытый текст из ГОСТ Р 34.12-2015, приложение А.1, подлежащий зашифрованию */
  ak_uint8 in[16] = {
    0x88, 0x99, 0xaa, 0xbb, 0xcc, 0xdd, 0xee, 0xff, 0x00, 0x77, 0x66, 0x55, 0x44, 0x33, 0x22, 0x11 };
  ak_uint8 openssl_in[] = {
    0x11,0x22,0x33,0x44,0x55,0x66,0x77,0x00,0xFF,0xEE,0xDD,0xCC,0xBB,0xAA,0x99,0x88,
    0x00,0x11,0x22,0x33,0x44,0x55,0x66,0x77,0x88,0x99,0xAA,0xBB,0xCC,0xEE,0xFF,0x0A,
    0x11,0x22,0x33,0x44,0x55,0x66,0x77,0x88,0x99,0xAA,0xBB,0xCC,0xEE,0xFF,0x0A,0x00,
    0x22,0x33,0x44,0x55,0x66,0x77,0x88,0x99,0xAA,0xBB,0xCC,0xEE,0xFF,0x0A,0x00,0x11,
    0x33,0x44,0x55,0x66,0x77,0x88,0x99,0xAA,0xBB,0xCC,0xEE,0xFF,0x0A,0x00,0x11,0x22,
    0x44,0x55,0x66,0x77,0x88,0x99,0xAA,0xBB,0xCC,0xEE,0xFF,0x0A,0x00,0x11,0x22,0x33,
    0x55,0x66,0x77,0x88,0x99,0xAA,0xBB,0xCC,0xEE,0xFF,0x0A,0x00,0x11,0x22,0x33,0x44,
 };

 /* зашифрованный блок из ГОСТ Р 34.12-2015 */
  ak_uint8 out[16] = {
    0xcd, 0xed, 0xd4, 0xb9, 0x42, 0x8d, 0x46, 0x5a, 0x30, 0x24, 0xbc, 0xbe, 0x90, 0x9d, 0x67, 0x7f };
  ak_uint8 openssl_out[] = {
    0x7f,0x67,0x9d,0x90,0xbe,0xbc,0x24,0x30,0x5a,0x46,0x8d,0x42,0xb9,0xd4,0xed,0xcd,
    0xb4,0x29,0x91,0x2c,0x6e,0x00,0x32,0xf9,0x28,0x54,0x52,0xd7,0x67,0x18,0xd0,0x8b,
    0xf0,0xca,0x33,0x54,0x9d,0x24,0x7c,0xee,0xf3,0xf5,0xa5,0x31,0x3b,0xd4,0xb1,0x57,
    0xd0,0xb0,0x9c,0xcd,0xe8,0x30,0xb9,0xeb,0x3a,0x02,0xc4,0xc5,0xaa,0x8a,0xda,0x98,
  };

 /* инициализируем библиотеку */
  if( !ak_libakrypt_create( ak_function_log_stderr )) return ak_libakrypt_destroy();

 /* устанавливаем нужный вариант совместимости и пересчитываем внутренние таблицы */
  ak_libakrypt_set_option( "openssl_compability", 1 );
  ak_bckey_context_kuznechik_init_gost_tables();

 /* создаем секретный ключ алгоритма Кузнечик */
  if( ak_bckey_context_create_kuznechik( &bkey ) != ak_error_ok )
    return ak_libakrypt_destroy();

 /* устанавливаем секретный ключ */
  if( ak_libakrypt_get_option( "openssl_compability" )) {
    ak_bckey_context_set_key( &bkey, openssl_key, sizeof( key ));
  }  else ak_bckey_context_set_key( &bkey, key, sizeof( key ));

 /* зашифровываем всего блок данных в режиме простой замены */
  if( ak_libakrypt_get_option( "openssl_compability" )) {
      bkey.encrypt( &bkey.key, openssl_in, buf );

      printf("encrypted: ");
      for( int i = 0; i < 16; i++ ) printf("%02x ", buf[i]);
      printf("\nexpected:  ");
      for( int i = 0; i < 16; i++ ) printf("%02x ", openssl_out[i]);
      printf("\n");

  } else {
      bkey.encrypt( &bkey.key, in, buf );

      printf("encrypted: ");
      for( int i = 0; i < 16; i++ ) printf("%02x ", buf[i]);
      printf("\nexpected:  ");
      for( int i = 0; i < 16; i++ ) printf("%02x ", out[i]);
      printf("\n");

      bkey.decrypt( &bkey.key, out, buf );

      printf("decrypted: ");
      for( int i = 0; i < 16; i++ ) printf("%02x ", buf[i]);
      printf("\nexpected:  ");
      for( int i = 0; i < 16; i++ ) printf("%02x ", in[i]);
      printf("\n");
  }

  ak_bckey_context_destroy( &bkey );
 return ak_libakrypt_destroy();
}
