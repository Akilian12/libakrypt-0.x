# Инструкция по сборке и установке

\section install_get Получение исходных текстов библиотеки

Cтабильная версия библиотеки распространяется в виде архива с исходными текстами


    libakrypt-0.x.y.tar.bz2


в котором `x` обозначает номер версии, а `y` номер релиза. Для разархивирования необходимо
выполнить команду


    tar -xjvf libakrypt-0.x.y.tar.bz2


Эту команду, как и все последующие, необходимо выполнять в консоли от имени обычного пользователя.
После разархивирования должен появиться каталог `libakrypt-0.x.y`, содержащий следующие подкаталоги


    cmake
    doc
    examples
    source
    tests


После разархивации исходных текстов можно переходить к сборке библиотеки.

Добавим, что последняя версия, возможно не стабильная, исходных текстов библиотеки
может быть получена из репозитория на сайте [github.com](http://github.com/axelkenzo/libakrypt-0.x).
Для клонирования репозитория необходимо выполнить из командной строки следующую команду.


    git clone https://github.com/axelkenzo/libakrypt-0.x


Необходимая документация и описание процедуры установки распределенной
системы управления версиями `git` могут быть найдены [здесь](http://git-scm.com).

\section install_build_system Система сборки

Системой сборки для библиотеки `libakrypt` является [cmake](https://cmake.org").
Система сборки не зависит от используемой операционной системы.
Необходимый набор программ и утилит может быть скачан с официального сайта программы cmake.

Установка `cmake`, как правило, доступна для стандартных средств операционной системы.
Нпример, в Debian или Ubuntu, установка `cmake` может быть выполнена следующей командой


    apt install cmake


Данная команда должна выполняться с правами суперпользователя.

\section install_depends Зависимости библиотеки

Библиотека `libakrypt` может реализовывать многопоточное выполнение некоторых криптографических преобразований,
используя для этого базовый набор функций для работы с потоками.
В настоящее время библиотека использует функции, определяемые `POSIX Threads`.

В операционных системах семейства `Linux`, а также в `FreeBSD`,
эта функциональность входит в состав библиотеки `libc`
и не требует дополнительных действий при установке.

В операционной системе `Windows` многопоточность может быть реализована различными способами, при этом
способ реализации определяется используемым для сборки библиотеки компилятором:

- в случае, если для сборки библиотеки используется компилятор `gcc`, входящий в состав
набора библиотек и программ `MinGW`, то доступ к многопоточной функциональности
предоставляется библиотекой `libc` из пакета `MinGW`.

- в случае, если для сборки библиотеки в операционной системе Windows
используется компилятор `Microsoft Visual C` (или любой другой,
поставляемый без библиотек, реализующих многопоточную функциональность),
то необходимо использование разделяемой
библиотеки `pthreads-w32` (POSIX Threads Library for Win32).
Перед сборкой библиотеки `libakrypt` Вам необходимо вручную установить заголовочные и библиотечные файлы
(`pthreadVC.lib` и `pthreadVC.dll`, а также заголовочные файлы `pthread.h`, `semaphore.h` и `sched.h`).
Подробное описание установки `pthreads-w32` может быть найдено
в документации по [pthreads-w32](http://sources.redhat.com/pthreads-win32).

Отметим, что в случае отсутствия библиотеки, реализующей `POSIX Threads`,
соответствующая функциональность при сборке будет удалена из библиотеки `libakrypt`.

\section install_unix Сборка в Unix

Основной средой разработки библиотеки `libakrypt` является Linux,
поэтому процесс сборки под Unix-like операционными системами является максимально простой процедурой.

\subsection install_unix_static Сборка статической версии библиотеки

После получения исходных кодов для сборки библиотеки выполните в консоли
следующую последовательность команд.


    mkdir build
    cd build
    cmake ../libakrypt-0.x
    make


В результате сборки, по-умолчанию, будет собрана статическая версия библиотеки --- `libakrypt-static.a`,
а также ряд примеров.

\subsection install_unix_dinamic Сборка динамической версии библиотеки

Для сборки динамической версии библиотеки --- `libakrypt-shared.so`,
необходимо выполнить команду `cmake` с дополнительным параметром,
указывающим факт сборки динамически исполняемой версии библиотеки.


    cmake -D LIBAKRYPT_SHARED_LIB=ON ../libakrypt-0.x


Таким образом последовательность команд для сборки принимает вид


    mkdir build
    cd build
    cmake -D LIBAKRYPT_SHARED_LIB=ON ../libakrypt-0.x
    make


\subsection install_unix_compilers Сборка различными компиляторами

Приведенная нами выше последовательность команд использует для сборки библиотеки
найденный `cmake` компилятор по-умолчанию -- в Linux это компилятор `gcc`, во FreeBSD и MacOS это `clang`.
Если Вы хотите использовать другой компилятор, то Вам необходимо использовать
при вызове `cmake` опцию `CMAKE_C_COMPILER`, в явном виде определяющую имя компилятора.

Так, следующий вызов позволит произвести сборку библиотеки с помощью компилятора `clang`.


    cmake -D CMAKE_C_COMPILER=clang ../libakrypt-0.x


Аналогично, следующий вызов позволит произвести сборку библиотеки с помощью компилятора `tcc` (Tiny C Compiler)


    cmake -D CMAKE_C_COMPILER=tcc ../libakrypt-0.x


Отметим, что через опцию `CMAKE_C_COMPILER` можно указывать только те компиляторы,
которые поддерживаются `cmake`.
Перечень поддерживаемых компиляторов можно найти в документации по `cmake`
(см. раздел cmake-compile-features, supported compilers).


\section install_windows Сборка в Windows

Ранее мы описали способ сборки библиотеки с
использованием компилятора `clang` из проекта `ellcc`.
Этот способ позволяет собирать только статическую версию библиотеки.
Вместе с тем, как динамическая, так и статическая версии
библиотеки могут быть успешно собраны под операционными системами семейства `Windows`.

\subsection install_windows_msvc Сборка с использованием компилятора Miscrosoft Visual C
На настоящий момент протестирована успешная сборка библиотеки с помощью компилятора MSVC версий 10 и старше.

Для сборки библиотеки и тестовых примеров необходимо запустить командную строку `Visual Studio` и
создать каталог для сборки, например, выполнив команду


    mkdir build-msvc

Далее, необходимо перейти в созданный каталог и запустить `cmake` для конфигурации сборки.


    cmake -G "NMake Makefiles" path

где `path` это путь к каталогу, в котором находятся исходные коды библиотеки, например, `../libakrypt-0.x`.
Далее сборка библиотеки и тестовых примеров выполняется следующей командой


    nmake

Указанный выше пример позволит создать статическую (.lib) библиотеку и тестовые примеры. Для сборки
динамической (.dll) версии библиотеки необходимо
дополнительно указать соответствующий флаг при вызове `cmake`.


    cmake -G "NMake Makefiles" -D LIBAKRYPT_SHARED_LIB=ON path

Для запуска тестовых примеров,
собранных с поддержкой динамических библиотек,
необходимо, чтобы созданном Вами каталоге `build` находился файл `pthreadVC2.dll`.

\subsection install_windows_gcc Сборка с использованием компилятора GCC
Для сборки компилятором `gcc` Вам необходимо установить набор программ из проекта `MinGW`.
Далее, в командной строке (используйте MinSYS) выполнить следующую последовательность команд.


    mkdir build
    cd build
    cmake -G "MinGW Makefiles" ../libakrypt-0.x
    mingw32-make.exe

Аналогично сказанному выше, для сборки
динамической библиотеки и тестовых примеров, собранных с поддержкой динамических библиотек,
необходимо выполнить следующую последовательность команд.


    mkdir build
    cd build
    cmake -G "MinGW Makefiles" -D LIBAKRYPT_SHARED_LIB=ON ../libakrypt-0.x
    mingw32-make.exe

\section install_unix_targets Сборка для исполнения под другими платформами

Помимо традиционной сборки, когда библиотека компилируется и выполняется
на одной и той же аппаратной платформе, можно реализовать процесс сборки, при которой эти платформы различаются.

Мы рассмотрим случай в котором платформой сборки (host system)
является Linux, а платформой выполнения (target system) --- любая другая
операционная система, например, Windows или Linux на ARM Cortex.
Для такой сборки наиболее удобным является компилятор `clang`,
или более точно, его сборка из проекта [ellcc](http://ellcc.org).
В данном проекте компилятору `clang` присвоено имя `ecc`.

Обязательным параметром, который должен передаваться компилятору `ecc`
является платформа (target system), на которой будет выполняться компилируемая программа.
Например, для сборки библиотеки под 64-x битную версию Windows (на архитектуре x64),
можно выполнить следующую команду.


    cmake -D CMAKE_C_COMPILER=ecc -D CMAKE_C_FLAGS="-target x86_64-w64-mingw32"
                 -D LIBAKRYPT_EXT=".exe" -D LIBAKRYPT_CONF="C:/" ../../libakrypt-0.x


Прокомментируем приведенные выше параметры команды `cmake`.

* Как и ранее, имя компилятора передается через переменную `CMAKE_C_COMPILER` (в нашем примере это `ecc`);
* Платформа сборки передается в `cmake` через переменную `CMAKE_C_FLAGS` (-target x86_64-w64-mingw32);
* Параметр `LIBAKRYPT_EXT` (.exe) указывает расширение для исполняемых файлов (это актуально только для Windows);
* Параметр `LIBAKRYPT_CONF` - каталог, в котором будет находиться файл с техническими характеристиками
библиотеки `libakrypt`.



\section compile_tests Сборка тестовых примеров

Для проверки корректноcти сборки библиотеки можно
собрать систему тестов, использующих не экспортируемые функции библиотеки.
По умолчанию, данная возможность выключена.
Для ее разблокировки достаточно выполнить


    cmake -D LIBAKRYPT_INTERNAL_TESTS=ON ../libakrypt-0.x

После этого при сборке библиотеки компилятор также соберет тестовые примеры.
(Использование данной возможности блокируется при сборке компилятором MSVC,
поскольку он не предоставляет прямой доступ к неэкспортируемым функциям).

Для запуска системы тестов достаточно запустить


    make test

После прохождения тестов будет выведена информация об общем числе успешно пройденных тестов,
а также времени их работы.

\section flags Перечни флагов для сборки библиотеки

В заключение, приведем перечень флагов, которые могут передаваться в `cmake` для настройки и уточнения значений
параметров сборки библиотеки.

* `LIBAKRYPT_CONF = path` (устанавливает каталог поиска файла `libakrypt.conf`, содержащего точные
значения технических характеристик библиотеки; в Unix-подобных системах значением по-умолчанию является каталог `/etc`)

* `LIBAKRYPT_EXT = extension` (устанавливает расширение для скомпилированных контрольных примеров,
используется, как правило, для установки расширения `.exe` в операционной системе `Windows`)

* `LIBAKRYPT_INTERNAL_TESTS = { ON, OFF }` (устанавливает надо или нет собирать тестовые примеры, использующие
вызовы функций внутреннего (не экспортируемого) интерфейса.
После установки флага становится доступной команда `make test`, запускающая процесс тестирования
функций внутреннего интерфейса.

* `LIBAKRYPT_GMP_TESTS = { ON, OFF }` (устанавливает надо или нет собирать тестовые примеры, использующие
вызовы функций библиотеки `libgmp`; данная функциональность нужна только для тестирования корректности реализации
арифметических операций с вычетами кольца больших целых чисел)

* `LIBAKRYPT_SHARED_LIB = { ON, OFF }` (устанавливает надо или нет собирать динамическую версию библиотеки, по умолчанию,
флаг равен `OFF`)

* `LIBAKRYPT_STATIC_LIB = { ON, OFF }` (устанавливает надо или нет собирать статическую версию библиотеки, по умолчанию,
флаг равен `ON`)

* `LIBAKRYPT_BIG_ENDIAN = { ON, OFF }` (в случае, когда флаг равен `ON`, используются фрагметны исходного кода для
выполнения на big-endian архитектуре; по умолчанию, флаг равен `OFF`)

\section install Инсталляция библиотеки

В текущей версии библиотеки поддерживается процесс
инсталляции библиотеки только под Unix-like операционными системами.

\subsection install_in_linux Инсталляция в Unix

По умолчанию предполагается, что библиотека будет установлена в каталог `/usr/local`.
Для изменения этого каталога
можно передать в `cmake` путь установки в явном виде. Например, следующий вызов позволяет
установить библиотеку в католог `/usr`.


    cmake -DCMAKE_INSTALL_PREFIX=/usr ../libakrypt-0.x


Для инсталляции библиотеки достаточно выполнить команду


    make install


**Внимание.** Команда инсталляции библиотеки должна выполняться с правами суперпользователя.

\section documentation Сборка документации

Часть документации,
не зависящая от исходных текстов библиотеки, располагается в каталоге `doc`.

Для сборки полной документациии необходимо установить
программу [Doxygen](http://www.doxygen.org/index.html).
После этого станет возможным собрать документацию в формате `html` с помощью вызова


    make doc

Созданная документация будет находиться в каталоге `doc`,
а также будет упакована в архив `libakrypt-doc-0.x.tar.bz2`. Дополнительно:

* если у Вас  установлена система подготовки документации LaTex,
то указанный вызов также создаст документацию в формате `pdf`
(должен появиться файл `libakrypt-doc-0.x.pdf`).

* если у Вас установлена программа qhelpgenerator (входит в стандартную установку библиотеки Qt),
то указанный вызов также создаст документацию в формате `qch`
(должен появиться файл `libakrypt-doc-0.x.qch`).
